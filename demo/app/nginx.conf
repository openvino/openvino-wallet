# yankee.openvino.org - reverse proxy exposing TrustBloc services on CDN-friendly ports

map $http_upgrade $connection_upgrade {
    default upgrade;
    ''      close;
}

# HTTP -> HTTPS redirect for the main entry point
server {
    listen 80;
    listen [::]:80;
    server_name yankee.openvino.org;
    return 301 https://$host$request_uri;
}

# Default HTTPS entry -> VC REST (8075)
server {
    listen 443 ssl http2;
    listen [::]:443 ssl http2;
    server_name yankee.openvino.org;

    ssl_certificate     /etc/letsencrypt/live/yankee.openvino.org/fullchain.pem;
    ssl_certificate_key /etc/letsencrypt/live/yankee.openvino.org/privkey.pem;
    include /etc/letsencrypt/options-ssl-nginx.conf;
    ssl_dhparam /etc/letsencrypt/ssl-dhparams.pem;

    location / {
        proxy_pass http://127.0.0.1:8075;
        proxy_http_version 1.1;
        proxy_set_header Host vc-rest-echo.trustbloc.local;
        proxy_set_header X-Forwarded-Proto https;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header Upgrade    $http_upgrade;
        proxy_set_header Connection $connection_upgrade;
        proxy_buffering off;
    }
}

# 2053/tcp (HTTPS) -> KrakenD (TLS backend 5566)
server {
    listen 2053 ssl;
    listen [::]:2053 ssl;
    server_name yankee.openvino.org;

    ssl_certificate     /etc/letsencrypt/live/yankee.openvino.org/fullchain.pem;
    ssl_certificate_key /etc/letsencrypt/live/yankee.openvino.org/privkey.pem;
    include /etc/letsencrypt/options-ssl-nginx.conf;
    ssl_dhparam /etc/letsencrypt/ssl-dhparams.pem;

    location / {
        proxy_pass https://127.0.0.1:5566;
        proxy_http_version 1.1;
        proxy_set_header Host api-gateway.trustbloc.local;
        proxy_set_header X-Forwarded-Proto https;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header Upgrade    $http_upgrade;
        proxy_set_header Connection $connection_upgrade;
        proxy_ssl_server_name on;
        proxy_ssl_name localhost;
        proxy_ssl_verify off;
        proxy_buffering off;
    }
}

# 2083/tcp (HTTPS) -> DID resolver (8072)
server {
    listen 2083 ssl http2;
    listen [::]:2083 ssl http2;
    server_name yankee.openvino.org;

    ssl_certificate     /etc/letsencrypt/live/yankee.openvino.org/fullchain.pem;
    ssl_certificate_key /etc/letsencrypt/live/yankee.openvino.org/privkey.pem;
    include /etc/letsencrypt/options-ssl-nginx.conf;
    ssl_dhparam /etc/letsencrypt/ssl-dhparams.pem;

    location / {
        proxy_pass http://127.0.0.1:8072;
        proxy_http_version 1.1;
        proxy_set_header Host did-resolver.trustbloc.local;
        proxy_set_header X-Forwarded-Proto https;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header Upgrade    $http_upgrade;
        proxy_set_header Connection $connection_upgrade;
        proxy_buffering off;
    }
}

# 2087/tcp (HTTPS) -> Attestation mock (8097)
server {
    listen 2087 ssl http2;
    listen [::]:2087 ssl http2;
    server_name yankee.openvino.org;

    ssl_certificate     /etc/letsencrypt/live/yankee.openvino.org/fullchain.pem;
    ssl_certificate_key /etc/letsencrypt/live/yankee.openvino.org/privkey.pem;
    include /etc/letsencrypt/options-ssl-nginx.conf;
    ssl_dhparam /etc/letsencrypt/ssl-dhparams.pem;

    location / {
        proxy_pass http://127.0.0.1:8097;
        proxy_http_version 1.1;
        proxy_set_header Host mock-attestation.trustbloc.local;
        proxy_set_header X-Forwarded-Proto https;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header Upgrade    $http_upgrade;
        proxy_set_header Connection $connection_upgrade;
        proxy_buffering off;
    }
}

# 2096/tcp (HTTPS) -> Login & Consent (TLS backend 8099)
server {
    listen 2096 ssl http2;
    listen [::]:2096 ssl http2;
    server_name yankee.openvino.org;

    ssl_certificate     /etc/letsencrypt/live/yankee.openvino.org/fullchain.pem;
    ssl_certificate_key /etc/letsencrypt/live/yankee.openvino.org/privkey.pem;
    include /etc/letsencrypt/options-ssl-nginx.conf;
    ssl_dhparam /etc/letsencrypt/ssl-dhparams.pem;

    location / {
        proxy_pass https://127.0.0.1:8099;
        proxy_http_version 1.1;
        proxy_set_header Host mock-login-consent.example.com;
        proxy_set_header X-Forwarded-Proto https;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header Upgrade    $http_upgrade;
        proxy_set_header Connection $connection_upgrade;
        proxy_ssl_server_name on;
        proxy_ssl_name localhost;
        proxy_ssl_verify off;
        proxy_buffering off;
    }
}

# 8443/tcp (HTTPS) -> Trust Registry (TLS backend 8100)
server {
    listen 8443 ssl http2;
    listen [::]:8443 ssl http2;
    server_name yankee.openvino.org;

    ssl_certificate     /etc/letsencrypt/live/yankee.openvino.org/fullchain.pem;
    ssl_certificate_key /etc/letsencrypt/live/yankee.openvino.org/privkey.pem;
    include /etc/letsencrypt/options-ssl-nginx.conf;
    ssl_dhparam /etc/letsencrypt/ssl-dhparams.pem;

    location / {
        proxy_pass https://127.0.0.1:8100;
        proxy_http_version 1.1;
        proxy_set_header Host mock-trust-registry.example.com;
        proxy_set_header X-Forwarded-Proto https;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header Upgrade    $http_upgrade;
        proxy_set_header Connection $connection_upgrade;
        proxy_ssl_server_name on;
        proxy_ssl_name localhost;
        proxy_ssl_verify off;
        proxy_buffering off;
    }
}

# 2052/tcp (HTTP) -> Static files (10096)
server {
    listen 2052;
    listen [::]:2052;
    server_name yankee.openvino.org;

    location / {
        proxy_pass http://127.0.0.1:10096;
        proxy_http_version 1.1;
        proxy_set_header Host file-server.trustbloc.local;
        proxy_set_header X-Forwarded-Proto http;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_buffering off;
    }
}

# 2095/tcp (HTTP) -> Cognito mock (9229)
server {
    listen 2095;
    listen [::]:2095;
    server_name yankee.openvino.org;

    location / {
        proxy_pass http://127.0.0.1:9229;
        proxy_http_version 1.1;
        proxy_set_header Host cognito-mock.trustbloc.local;
        proxy_set_header X-Forwarded-Proto http;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_buffering off;
    }
}
